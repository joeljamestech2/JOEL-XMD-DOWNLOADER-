<script>
  async function downloadBlobFile(url, filename) {
    try {
      const res = await fetch(url);
      const blob = await res.blob();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    } catch {
      alert("‚ùå Failed to download.");
    }
  }

  async function searchYouTube() {
    const query = document.getElementById("searchQuery").value.trim();
    const resultContainer = document.getElementById("resultContainer");
    const errorMsg = document.getElementById("errorMsg");
    resultContainer.innerHTML = '';
    errorMsg.textContent = '';

    if (!query) {
      errorMsg.textContent = "‚ùå Please enter a search keyword.";
      return;
    }

    try {
      const cors = 'https://corsproxy.io/?';
      const searchUrl = `${cors}https://my-rest-apis-six.vercel.app/yts?query=${encodeURIComponent(query)}`;
      const searchRes = await fetch(searchUrl);
      const searchJson = await searchRes.json();

      if (searchJson.status !== "success" || !searchJson.results.length) {
        throw new Error("No YouTube results found.");
      }

      const firstResult = searchJson.results[0];
      const videoUrl = firstResult.url;

      const thumb = firstResult.thumbnail;
      const title = firstResult.title;
      const duration = firstResult.duration;
      const views = firstResult.views.toLocaleString();
      const author = firstResult.author;
      const published = firstResult.published;

      resultContainer.innerHTML = `
        <div class="result">
          <img class="thumbnail" src="${thumb}" alt="Thumbnail">
          <div class="info">
            <h2>${title}</h2>
            <p><strong>Author:</strong> ${author}</p>
            <p><strong>Duration:</strong> ${duration}</p>
            <p><strong>Views:</strong> ${views}</p>
            <p><strong>Published:</strong> ${published}</p>
            <p id="loadingStatus" style="color: orange;">üîÑ Preparing download links...</p>
            <div class="downloads" id="downloadBtns" style="display: none;">
              <button id="audioBtn">‚¨á Download Audio</button>
              <button id="videoBtn">‚¨á Download Video</button>
            </div>
          </div>
        </div>
      `;

      // Fetch audio and video download links in background
      const ytmp3Url = `${cors}https://apis.davidcyriltech.my.id/download/ytmp3?url=${encodeURIComponent(videoUrl)}`;
      const ytmp4Url = `${cors}https://apis.davidcyriltech.my.id/download/ytmp4?url=${encodeURIComponent(videoUrl)}`;

      const [audioRes, videoRes] = await Promise.all([
        fetch(ytmp3Url).then(r => r.json()),
        fetch(ytmp4Url).then(r => r.json())
      ]);

      const audioLink = audioRes.result?.download_url;
      const videoLink = videoRes.result?.download_url;

      const downloadBtns = document.getElementById('downloadBtns');
      const audioBtn = document.getElementById('audioBtn');
      const videoBtn = document.getElementById('videoBtn');
      const loadingStatus = document.getElementById('loadingStatus');

      if (audioLink) {
        audioBtn.onclick = () => downloadBlobFile(audioLink, 'audio.mp3');
      } else {
        audioBtn.disabled = true;
        audioBtn.textContent = "‚ùå Audio Failed";
      }

      if (videoLink) {
        videoBtn.onclick = () => downloadBlobFile(videoLink, 'video.mp4');
      } else {
        videoBtn.disabled = true;
        videoBtn.textContent = "‚ùå Video Failed";
      }

      loadingStatus.textContent = "‚úÖ Download ready!";
      downloadBtns.style.display = 'flex';

    } catch (err) {
      console.error(err);
      errorMsg.textContent = "‚ùå " + err.message;
    }
  }
</script>
